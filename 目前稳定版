// ==UserScript==
// @name         JavDB è·³è½¬åŠ©æ‰‹ (v3.2 ä¸‰ç«™é€šç”¨ç‰ˆ)
// @namespace    http://tampermonkey.net/
// @version      3.2
// @description  æ”¯æŒ MemoJAV, Jable.tv, SupJAVã€‚éžä¾µå…¥å¼æ‚¬æµ®æŒ‰é’®ï¼Œä¸å´©æºƒã€ä¸æ¼‚ç§»ã€‚
// @author       Assistant
// @match        https://jable.tv/*
// @match        https://memojav.com/video/*
// @match        https://supjav.com/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // 1. åˆ›å»ºå…¨å±€â€œå¹½çµæŒ‰é’®â€
    const ghostBtn = document.createElement('a');
    ghostBtn.id = 'javdb-ghost-btn';
    ghostBtn.target = '_blank';
    ghostBtn.style.cssText = `
        position: fixed;
        display: none;
        z-index: 2147483647;
        background: #007bff; /* æ”¹ä¸ºè“è‰²ï¼Œæ›´åƒæœç´¢ */
        color: white !important;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: bold;
        text-decoration: none !important;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        pointer-events: auto;
    `;
    document.body.appendChild(ghostBtn);

    // ä¼˜åŒ–çš„ç•ªå·æå–æ­£åˆ™ï¼šæ”¯æŒ å­—æ¯-æ•°å­—, å­—æ¯æ•°å­—ï¼ˆæ— æ¨ªæ ï¼‰, ä»¥åŠé•¿ç•ªå·
    const getAvCode = (t) => {
        if (!t) return null;
        // åŒ¹é…å¸¸è§çš„ç•ªå·æ ¼å¼
        const m = t.match(/([a-z0-9]{2,}-[0-9]{3,}|[a-z0-9]{3,10}[0-9]{3,10})/i);
        return m ? m[0].toUpperCase() : null;
    };

    let currentActiveTarget = null;

    // å®žæ—¶æ›´æ–°ä½ç½®å‡½æ•°
    function updatePosition() {
        if (currentActiveTarget && ghostBtn.style.display === 'block') {
            const rect = currentActiveTarget.getBoundingClientRect();
            // å›ºå®šå®šä½ï¼šç›´æŽ¥æ ¹æ®è§†å£åæ ‡è®¾ç½®
            ghostBtn.style.top = (rect.top + 10) + 'px';
            ghostBtn.style.left = (rect.left + 10) + 'px';
        }
    }

    // 2. æ ¸å¿ƒç›‘å¬å™¨
    document.addEventListener('mouseover', function(e) {
        // è‡ªåŠ¨è¯†åˆ«ä¸‰ç«™çš„è§†é¢‘å®¹å™¨ï¼š
        // Jable: .video-img-box | MemoJAV: .video-poster | SupJAV: .post
        const target = e.target.closest('.video-img-box, .post, .video-item, h4, h1, .detail');

        if (target) {
            let code = "";

            // å°è¯•ä»Žä¸åŒçš„åœ°æ–¹æžç•ªå·ï¼šæ ‡é¢˜é“¾æŽ¥ã€å›¾ç‰‡ altã€æˆ–è€…æ˜¯å…ƒç´ æ–‡æœ¬
            const titleA = target.querySelector('a[title], .title a, h3 a');
            const img = target.querySelector('img');

            if (titleA && titleA.getAttribute('title')) {
                code = getAvCode(titleA.getAttribute('title'));
            }
            if (!code && titleA) {
                code = getAvCode(titleA.innerText);
            }
            if (!code && img) {
                code = getAvCode(img.getAttribute('alt'));
            }
            if (!code) {
                code = getAvCode(target.innerText);
            }

            if (code) {
                currentActiveTarget = target;
                ghostBtn.href = `https://javdb.com/search?q=${code}&f=all`;
                ghostBtn.innerText = `ðŸ” JavDB: ${code}`;
                ghostBtn.style.display = 'block';
                updatePosition();
                return;
            }
        }

        // é¼ æ ‡ç§»å‡ºé€»è¾‘
        if (!e.target.closest('#javdb-ghost-btn')) {
            ghostBtn.style.display = 'none';
            currentActiveTarget = null;
        }
    }, true);

    // æ»šåŠ¨æ—¶åŒæ­¥ä½ç½®
    window.addEventListener('scroll', updatePosition, { passive: true });

    // 3. ç‰¹æ®Šé€‚é…ï¼šé’ˆå¯¹è¯¦æƒ…é¡µæŒ‰é’®ç»„çš„æ•´åˆ (MemoJAV åŽŸç”Ÿé£Žæ ¼)
    const setupNativeButtons = () => {
        const host = window.location.host;
        if (host.includes('memojav.com')) {
            const toolbar = document.querySelector('div.flex.mtb16');
            if (toolbar && !document.getElementById('javdb-memo-native')) {
                const codeEl = document.querySelector('p.description-horizontal');
                if (codeEl) {
                    const code = getAvCode(codeEl.innerText);
                    const btn = document.createElement('a');
                    btn.id = 'javdb-memo-native';
                    btn.className = 'box-main flex';
                    btn.style.cssText = 'background-color:#007bff; margin-left:8px; color:white; padding:0 12px; border-radius:4px;';
                    btn.href = `https://javdb.com/search?q=${code}&f=all`;
                    btn.target = '_blank';
                    btn.innerHTML = `<span style="font-size:12px;">JavDB: ${code}</span>`;
                    toolbar.appendChild(btn);
                }
            }
        }
    };

    setInterval(setupNativeButtons, 2000);

})();
